{% extends "layout.html" %}

{% block title %}
    New Pet
{% endblock %}

{% block main %}

    <h1>Add your pet data</h1>
    <form id="newPet" action="/new_pet" method="post" class="vertical_padding" enctype="multipart/form-data">
        {{ form.hidden_tag() }} 
        <!-- Step 1 -->
        <div id="step1" class="step">
            <!-- Renderize using Flask-WTF -->
            <h2>Basic Information</h2>
            <br>
            <div class="form-group">
                <label class="form-label" for="photo">Photo:</label>
                {{ form.pet_profile_photo(id="new_pet_photo", accept="image/*") }}
                <br>
                <small class="form-text text-muted">Upload a photo of your pet. The image will be cropped automatically to a circle.</small>
            </div>
            <div id="preview-container" class="mt-3" style="display: none;">
                <p>Preview:</p>
                <img id="image-preview" src="" alt="Preview of the uploaded image" class="img-fluid shadow pet_pfp">
            </div>
            <br>

            <label  for="name">Name:</label>
            {{ form.name(autocomplete="off", required=True) }}
            <br><br>

            <label for="birth_date">Birth date:</label>
            {{ form.birth_date() }}  
            <br><br>

            <label for="adoption_date">Adoption date:</label>
            {{ form.adoption_date() }}  
            <br><br>

            <label for="sex">Sex:</label>
            {{ form.sex() }}
            <br><br>

            <label for="species">Species:</label>
            {{ form.species() }}
            <br><br>

            <div id="breed-container">
                <label for="breed">Breed:</label>
                {{ form.breed() }}<br>
                <small class="form-text text-muted">Select 'Mixed' if you can't find your breed.</small>
            </div>
            <br><br>
    
            <button type="button" id="nextButton" class="continue-btn dark_btn btn">Continue</button>
        </div>

        <!-- Step 2 -->
        <div id="step2" class="step" style="display: none;">
            <h2>Health Data</h2>
            <label for="sterilized">Sterilized:</label>
            {{ form.sterilized() }}
            <br><br>
            <label for="microchip_number">Microchip (optional):</label>
            {{ form.microchip_number() }}
            <br><br>
            <label for="insurance_company">Insurance Company (optional):</label>
            {{ form.insurance_company() }}
            <br><br>
            <label for="insurance_number">Insurance No. (optional):</label>
            {{ form.insurance_number() }}
            <br><br>
            <button type="submit" class="submit-btn dark_btn btn">Register Pet</button>
        </div>
    </form>

    <script>
        // Steps management
        $(document).ready(function() {
            // Show breeds depending on selected specie
            $('#species').change(function() {
                var species_id = $(this).val();
                var breedSelect = $('#breed');
                breedSelect.empty();
                breedSelect.append('<option value="" disabled selected>Loading breeds...</option>');

                $.ajax({
                    url: '/get_breeds/' + species_id,
                    method: 'GET',
                    success: function(data) {
                        console.log(data); // Log data for debugging
                        breedSelect.empty();
                        breedSelect.append('<option value="" disabled selected>Select a breed</option>');
                        $.each(data, function(index, breed) {
                            breedSelect.append('<option value="' + breed.id + '">' + breed.name + '</option>');
                        });
                    },
                    error: function(xhr, status, error) {
                        console.error("Error fetching breeds:", error);
                        alert("Failed to load breeds. Please try again.");
                    }
                });
            });

            $('#nextButton').click(function() {
                $('#step1').hide();
                $('#step2').show();
            });
        });

        // Crop pet profile picture
        document.addEventListener('DOMContentLoaded', function () {
            const inputPhoto = document.getElementById('new_pet_photo');
            const previewContainer = document.getElementById('preview-container');
            const imagePreview = document.getElementById('image-preview');
            const croppedImageData = document.getElementById('cropped-image-data');
            const MAX_FILE_SIZE_MB = 5; // Max size 5MB

            inputPhoto.addEventListener('change', function (event) {
            const file = event.target.files[0];
            if (file) {
                if (file.size > MAX_FILE_SIZE_MB * 1024 * 1024) {
                    alert("The file is too large. Maximum size is " + MAX_FILE_SIZE_MB + " MB.");
                    inputPhoto.value = "";
                    return;
                }

                if (!file.type.startsWith('image/')) {
                    alert("Please upload a valid image file.");
                    inputPhoto.value = "";
                    return;
                }

                const reader = new FileReader();
                reader.onload = function (e) {
                    imagePreview.src = e.target.result;
                    previewContainer.style.display = 'block';
                };
                
                reader.readAsDataURL(file);
                }
            });
        });

    </script>


{% endblock %}